<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klantenbeheer - QPlanning</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../medewerkerbeheer.css">
</head>
<body>
    <header class="header">
        <div class="header-container">
            <!-- Logo and main navigation -->
            <div class="header-left">
                <div class="logo">
                    <h1>QPlanning</h1>
                </div>
                <nav class="main-nav">
                    <ul class="nav-list">
                        <li><a href="/index.html" class="nav-link active">Overzicht</a></li>
                        <li class="dropdown">
                            <a href="#" class="nav-link dropdown-toggle">Plannen</a>
                            <ul class="dropdown-menu">
                                <li><a href="/Boekingen/BoekingOverzicht.html" class="dropdown-link">Boekingen</a></li>
                                <li><a href="#" class="dropdown-link">Klantenplanning</a></li>
                                <li><a href="#" class="dropdown-link">Medewerkerplanning</a></li>
                            </ul>
                        </li>
                        <li class="dropdown">
                            <a href="#" class="nav-link dropdown-toggle">Beheer</a>
                            <ul class="dropdown-menu">
                                <li><a href="/klanten/klant.html" class="dropdown-link">Klanten beheren</a></li>
                                <li><a href="/Medewerker/medewerkerbeheer.html" class="dropdown-link">Medewerkers beheren</a></li>
                                <li><a href="#" class="dropdown-link">Gebruikers beheren</a></li>
                            </ul>
                        </li>
                    </ul>
                </nav>
            </div>
            
            <div class="header-right">
                <div class="account-dropdown">
                    <button class="account-btn" id="accountBtn">
                        <svg class="account-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </button>
                    <ul class="account-menu" id="accountMenu">
                        <li><a href="#" class="account-link">Wijzig wachtwoord</a></li>
                        <li><a href="#" class="account-link">Log uit</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="content-container">
            <div class="page-header">
                <h2>Klantenbeheer</h2>
                <button class="btn btn-primary" id="add-klant-btn">Nieuwe klant toevoegen</button>
            </div>

            <div class="filters-section">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Zoek klanten op naam, partner..." class="search-input">
                    <button class="search-clear" id="clearSearch" title="Zoekopdracht wissen" style="display: none;">√ó</button>
                </div>
                <div class="filter-options">
                    <select id="partnerFilter" class="filter-select">
                        <option value="">Alle Partners</option>
                        </select>
                    <select id="teamFilter" class="filter-select">
                        <option value="">Alle Teams</option>
                        </select>
                    <button class="btn btn-secondary" id="clearFilters">Filters wissen</button>
                </div>
            </div>

            <div class="bulk-actions-bar" id="bulkActionsBar" style="display: none;">
                <div class="bulk-info">
                    <span id="selectedCount">0</span> klanten geselecteerd
                </div>
                <div class="bulk-buttons">
                    <button class="btn btn-secondary" id="bulkDelete">Verwijderen</button>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="select-column"><input type="checkbox" id="selectAllCheckbox" class="select-checkbox"></th>
                            <th>Klant naam</th>
                            <th>Partner/Manager</th>
                            <th>Budget</th>
                            <th>Startdatum</th>
                            <th>Einddatum</th>
                            <th>Acties</th>
                        </tr>
                    </thead>
                    <tbody id="klanten-tabel-body">
                        </tbody>
                </table>
            </div>

            <div class="no-results" id="noResults" style="display: none;">
                <div class="no-results-icon">üîç</div>
                <h3>Geen klanten gevonden</h3>
                <p>Probeer andere zoektermen of filters.</p>
                <button class="btn btn-primary" id="clearAllFilters">Alle filters wissen</button>
            </div>
        </div>
    </main>

    <div class="modal" id="klant-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Nieuwe klant</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="form-info">
                <small>* Verplichte velden</small>
            </div>
            <form id="klant-form" class="modal-body" novalidate>
                <input type="hidden" id="klant-id">
                
                <div class="form-group">
                    <label for="klant-naam">Klant naam *</label>
                    <input type="text" id="klant-naam" name="klantNaam" placeholder="Bijv. Groot Bedrijf BV" required>
                    <div class="error-message" id="klantNaamError"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="klant-boekjaar">Boekjaar</label>
                        <input type="text" id="klant-boekjaar" name="boekjaar" maxlength="4" placeholder="2025">
                    </div>
                    <div class="form-group">
                        <label for="klant-budget">Budget (‚Ç¨) *</label>
                        <input type="number" id="klant-budget" name="budget" placeholder="Bijv. 10000" required step="0.01" min="0">
                        <div class="error-message" id="budgetError"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="klant-partner">Partner/Manager *</label>
                    <select id="klant-partner" name="partnerManager" required>
                        <option value="" disabled selected>Selecteer...</option>
                        <option value="Jan Jansen">Jan Jansen</option>
                        <option value="Marieke de Vries">Marieke de Vries</option>
                        <option value="Pieter Smit">Pieter Smit</option>
                    </select>
                    <div class="error-message" id="partnerManagerError"></div>
                </div>

                <div class="form-group">
                    <label for="klant-verantwoordelijk">Verantwoordelijk team</label>
                    <select id="klant-verantwoordelijk" name="verantwoordelijkTeam">
                        <option value="">Selecteer...</option>
                        <option value="Team Audit A">Team Audit A</option>
                        <option value="Team Accountancy">Team Accountancy</option>
                        <option value="Team Advies">Team Advies</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="klant-planbaar">Planbaar door teams</label>
                    <input type="text" id="klant-planbaar" name="planbaarDoorTeams" placeholder="Bijv. Team Audit A, Team Audit B">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="klant-startdatum">Startdatum</label>
                        <input type="date" id="klant-startdatum" name="startdatum">
                    </div>
                    <div class="form-group">
                        <label for="klant-einddatum">Einddatum</label>
                        <input type="date" id="klant-einddatum" name="einddatum">
                    </div>
                </div>
            </form>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelBtn">Annuleren</button>
                <button type="submit" class="btn btn-primary" form="klant-form" id="modal-save-btn">Opslaan</button>
            </div>
        </div>
    </div>

    <div class="modal" id="errorModal">
        <div class="modal-content error-modal-content">
            <div class="modal-header">
                <h3>Er zijn fouten gevonden</h3>
                <button class="modal-close" id="closeErrorModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="error-list" id="errorList">
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="closeErrorBtn">OK</button>
            </div>
        </div>
    </div>

    <div class="modal" id="confirmModal">
        <div class="modal-content confirm-modal-content">
            <div class="modal-header">
                <h3 id="confirmTitle">Bevestiging vereist</h3>
                <button class="modal-close" id="closeConfirmModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="confirm-icon" id="confirmIcon">‚ö†Ô∏è</div>
                <p id="confirmMessage">Weet je zeker dat je deze actie wilt uitvoeren?</p>
                <div class="confirm-details" id="confirmDetails" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelConfirmBtn">Annuleren</button>
                <button type="button" class="btn btn-danger" id="confirmBtn">Bevestigen</button>
            </div>
        </div>
    </div>

    <div class="success-notification" id="successNotification" style="display: none;">
        <div class="success-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <path d="M9 12l2 2 4-4"></path><circle cx="12" cy="12" r="10"></circle>
            </svg>
        </div>
        <div class="success-message" id="successMessage">Actie succesvol uitgevoerd</div>
        <button class="success-close" id="closeSuccessNotification">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"></path>
            </svg>
        </button>
    </div>


    <script>
        // --- Helper Functies ---
        function formatCurrency(value) {
            if (value === null || value === undefined || value === '') return '-';
            try {
                const number = parseFloat(value);
                if (isNaN(number)) return '-';
                return '‚Ç¨ ' + number.toLocaleString('nl-NL', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } catch (e) {
                return '-';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return '-';
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}-${month}-${year}`;
            } catch (e) {
                return '-';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            
            // --- Variabelen ---
            let klantenData = []; // Volledige dataset
            let gefilterdeKlanten = []; // Getoonde dataset
            let geselecteerdeIds = new Set();
            const localStorageKey = 'qplanning_klanten_v2'; 
            
            // DOM Elementen
            const tabelBody = document.getElementById('klanten-tabel-body');
            const addKlantBtn = document.getElementById('add-klant-btn');
            
            // Modal
            const modal = document.getElementById('klant-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalSaveBtn = document.getElementById('modal-save-btn');
            const closeModalBtn = document.getElementById('closeModal');
            const cancelBtn = document.getElementById('cancelBtn');
            const klantForm = document.getElementById('klant-form');
            
            // Filters
            const searchInput = document.getElementById('searchInput');
            const clearSearchBtn = document.getElementById('clearSearch');
            const partnerFilter = document.getElementById('partnerFilter');
            const teamFilter = document.getElementById('teamFilter');
            const clearFiltersBtn = document.getElementById('clearFilters');
            const clearAllFiltersBtn = document.getElementById('clearAllFilters');
            
            // Bulk Actions
            const bulkActionsBar = document.getElementById('bulkActionsBar');
            const selectedCountEl = document.getElementById('selectedCount');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const bulkDeleteBtn = document.getElementById('bulkDelete');

            // Meldingen
            const noResults = document.getElementById('noResults');
            const tableContainer = document.querySelector('.table-container');
            const errorModal = document.getElementById('errorModal');
            const closeErrorModal = document.getElementById('closeErrorModal');
            const closeErrorBtn = document.getElementById('closeErrorBtn');
            const confirmModal = document.getElementById('confirmModal');
            const successNotification = document.getElementById('successNotification');

            // --- Dropdown Logica (Header) ---
            const dropdowns = document.querySelectorAll('.dropdown');
            const accountBtn = document.getElementById('accountBtn');
            const accountMenu = document.getElementById('accountMenu');
            dropdowns.forEach(dropdown => {
                const toggle = dropdown.querySelector('.dropdown-toggle');
                toggle.addEventListener('click', function(e) {
                    e.preventDefault(); e.stopPropagation();
                    dropdowns.forEach(d => { if (d !== dropdown) d.classList.remove('active'); });
                    dropdown.classList.toggle('active');
                });
            });
            const accountDropdown = document.querySelector('.account-dropdown');
            accountBtn.addEventListener('click', function(e) {
                e.preventDefault(); e.stopPropagation();
                accountDropdown.classList.toggle('active');
            });
            document.addEventListener('click', function() {
                dropdowns.forEach(d => d.classList.remove('active'));
                accountDropdown.classList.remove('active');
            });
            document.querySelectorAll('.dropdown-menu, .account-menu').forEach(menu => {
                menu.addEventListener('click', e => e.stopPropagation());
            });

            // --- Data & Opslag Logica ---
            function saveKlanten() {
                localStorage.setItem(localStorageKey, JSON.stringify(klantenData));
            }

            async function laadKlanten() {
                const opgeslagenData = localStorage.getItem(localStorageKey);
                let dataGeldig = false;

                if (opgeslagenData) {
                    try {
                        const data = JSON.parse(opgeslagenData);
                        if (Array.isArray(data)) {
                             klantenData = data;
                             dataGeldig = true;
                        }
                    } catch (e) { dataGeldig = false; }
                }

                if (!dataGeldig) {
                    console.log("Geen (of ongeldige) localStorage data, laden uit klanten.json...");
                    try {
                        const response = await fetch('/klanten/klanten.json'); 
                        if (!response.ok) throw new Error('Kon klanten.json niet laden');
                        klantenData = await response.json();
                        saveKlanten(); 
                    } catch (error) {
                        console.error('Fout bij laden:', error);
                        tabelBody.innerHTML = `<tr><td colspan="7">Kon data niet laden.</td></tr>`;
                    }
                }
                
                populateFilters();
                applyFilters();
            }

            // --- Filter Logica ---
            function populateFilters() {
                const partners = new Set(klantenData.map(k => k.partnerManager).filter(Boolean));
                const teams = new Set(klantenData.map(k => k.verantwoordelijkTeam).filter(Boolean));

                partnerFilter.innerHTML = '<option value="">Alle Partners</option>';
                partners.forEach(partner => {
                    const option = new Option(partner, partner);
                    partnerFilter.add(option);
                });

                teamFilter.innerHTML = '<option value="">Alle Teams</option>';
                teams.forEach(team => {
                    const option = new Option(team, team);
                    teamFilter.add(option);
                });
            }

            function applyFilters() {
                const zoekTerm = searchInput.value.toLowerCase();
                const partner = partnerFilter.value;
                const team = teamFilter.value;

                gefilterdeKlanten = klantenData.filter(klant => {
                    const zoekMatch = !zoekTerm ||
                        klant.klantNaam.toLowerCase().includes(zoekTerm) ||
                        klant.partnerManager.toLowerCase().includes(zoekTerm) ||
                        (klant.verantwoordelijkTeam && klant.verantwoordelijkTeam.toLowerCase().includes(zoekTerm));
                    
                    const partnerMatch = !partner || klant.partnerManager === partner;
                    const teamMatch = !team || klant.verantwoordelijkTeam === team;

                    return zoekMatch && partnerMatch && teamMatch;
                });

                renderTabel();
                updateBulkActionsBar(); // Zorgt dat selectie gereset wordt
            }

            // --- Tabel Render Logica ---
            function renderTabel() {
                tabelBody.innerHTML = ''; 
                
                if (gefilterdeKlanten.length === 0) {
                    tableContainer.style.display = 'none';
                    noResults.style.display = 'block';
                } else {
                    tableContainer.style.display = 'block';
                    noResults.style.display = 'none';
                }

                gefilterdeKlanten.forEach(klant => {
                    const tr = document.createElement('tr');
                    tr.dataset.id = klant.id;
                    const isChecked = geselecteerdeIds.has(klant.id);
                    
                    tr.innerHTML = `
                        <td class="select-column"><input type="checkbox" class="row-checkbox select-checkbox" data-id="${klant.id}" ${isChecked ? 'checked' : ''}></td>
                        <td data-label="Klant naam">${klant.klantNaam || '-'}</td>
                        <td data-label="Partner/Manager">${klant.partnerManager || '-'}</td>
                        <td data-label="Budget">${formatCurrency(klant.budget)}</td>
                        <td data-label="Startdatum">${formatDate(klant.startdatum)}</td>
                        <td data-label="Einddatum">${formatDate(klant.einddatum)}</td>
                        <td class="actions">
                            <div class="action-buttons">
                                <button class="btn-action btn-edit" data-id="${klant.id}" title="Bewerken">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                    <span>Bewerken</span>
                                </button>
                                <button class="btn-action btn-delete" data-id="${klant.id}" title="Verwijderen">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                    <span>Verwijderen</span>
                                </button>
                            </div>
                        </td>
                    `;
                    tabelBody.appendChild(tr);
                });

                koppelTabelActies();
            }

            // --- Koppel Acties ---
            function koppelTabelActies() {
                // Checkboxen
                tabelBody.querySelectorAll('.row-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const id = parseInt(e.target.dataset.id);
                        if (e.target.checked) {
                            geselecteerdeIds.add(id);
                        } else {
                            geselecteerdeIds.delete(id);
                        }
                        updateBulkActionsBar();
                    });
                });

                // Edit Knoppen
                tabelBody.querySelectorAll('.btn-edit').forEach(knop => {
                    knop.addEventListener('click', (e) => {
                        const id = parseInt(e.currentTarget.dataset.id);
                        openKlantModal('edit', id);
                    });
                });
                
                // Delete Knoppen
                tabelBody.querySelectorAll('.btn-delete').forEach(knop => {
                    knop.addEventListener('click', (e) => {
                        const id = parseInt(e.currentTarget.dataset.id);
                        const klant = klantenData.find(k => k.id === id);
                        showConfirmDelete([id], klant ? `klant "${klant.klantNaam}"` : 'deze klant');
                    });
                });
            }

            // --- Bulk Actie Logica ---
            function setupBulkSelection() {
                selectAllCheckbox.addEventListener('change', () => {
                    if (selectAllCheckbox.checked) {
                        gefilterdeKlanten.forEach(k => geselecteerdeIds.add(k.id));
                    } else {
                        gefilterdeKlanten.forEach(k => geselecteerdeIds.delete(k.id));
                    }
                    renderTabel();
                    updateBulkActionsBar();
                });

                bulkDeleteBtn.addEventListener('click', () => {
                    showConfirmDelete([...geselecteerdeIds], `${geselecteerdeIds.size} klanten`);
                });
            }

            function updateBulkActionsBar() {
                const geselecteerdInView = gefilterdeKlanten.filter(k => geselecteerdeIds.has(k.id)).length;
                
                if (geselecteerdInView === 0) {
                    bulkActionsBar.style.display = 'none';
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    bulkActionsBar.style.display = 'flex';
                    selectedCountEl.textContent = geselecteerdInView;
                    selectAllCheckbox.checked = geselecteerdInView === gefilterdeKlanten.length;
                    selectAllCheckbox.indeterminate = geselecteerdInView < gefilterdeKlanten.length;
                }
            }
            
            // --- Modal Logica ---
            function openKlantModal(mode, klantId = null) {
                clearAllErrors();
                klantForm.reset();
                document.getElementById('klant-id').value = '';

                if (mode === 'edit') {
                    const klant = klantenData.find(k => k.id === klantId);
                    if (!klant) return;

                    modalTitle.textContent = 'Klant Bewerken';
                    modalSaveBtn.textContent = 'Wijzigingen Opslaan';
                    document.getElementById('klant-id').value = klant.id;
                    document.getElementById('klant-naam').value = klant.klantNaam || '';
                    document.getElementById('klant-boekjaar').value = klant.boekjaar || '';
                    document.getElementById('klant-budget').value = klant.budget || '';
                    document.getElementById('klant-partner').value = klant.partnerManager || '';
                    document.getElementById('klant-verantwoordelijk').value = klant.verantwoordelijkTeam || '';
                    document.getElementById('klant-planbaar').value = klant.planbaarDoorTeams || '';
                    document.getElementById('klant-startdatum').value = klant.startdatum || '';
                    document.getElementById('klant-einddatum').value = klant.einddatum || '';
                } else {
                    modalTitle.textContent = 'Nieuwe klant toevoegen';
                    modalSaveBtn.textContent = 'Opslaan';
                }
                modal.style.display = 'flex'; // GEWIJZIGD
            }

            function closeModal() {
                modal.style.display = 'none';
                clearAllErrors();
                klantForm.reset();
            }

            // --- Validatie Logica ---
            function validateForm() {
                const errors = [];
                const velden = {
                    klantNaam: { id: 'klant-naam', naam: 'Klant naam' },
                    budget: { id: 'klant-budget', naam: 'Budget' },
                    partnerManager: { id: 'klant-partner', naam: 'Partner/Manager' }
                };

                // Check verplichte velden
                Object.values(velden).forEach(veld => {
                    const element = document.getElementById(veld.id);
                    if (!element.value || element.value.trim() === '') {
                        errors.push({ id: veld.id, bericht: `${veld.naam} is verplicht.` });
                    }
                });

                // Specifieke validaties
                const klantNaam = document.getElementById(velden.klantNaam.id).value;
                if (klantNaam && klantNaam.length < 2) {
                    errors.push({ id: velden.klantNaam.id, bericht: 'Klant naam moet minimaal 2 karakters lang zijn.' });
                }

                const budget = document.getElementById(velden.budget.id).value;
                if (budget && parseFloat(budget) < 0) {
                    errors.push({ id: velden.budget.id, bericht: 'Budget mag niet negatief zijn.' });
                }
                
                return errors;
            }

            function showValidationErrors(errors) {
                const errorList = document.getElementById('errorList');
                errorList.innerHTML = '';
                
                errors.forEach(err => {
                    // Toon in modal
                    const errorEl = document.getElementById(err.id + 'Error');
                    if (errorEl) {
                        errorEl.textContent = err.bericht;
                        errorEl.classList.add('show');
                    }
                    document.getElementById(err.id)?.classList.add('error');
                    
                    // Toon in popup
                    const li = document.createElement('div');
                    li.className = 'error-item';
                    li.textContent = '‚Ä¢ ' + err.bericht;
                    errorList.appendChild(li);
                });
                errorModal.style.display = 'flex'; // GEWIJZIGD
            }

            function clearAllErrors() {
                klantForm.querySelectorAll('input, select').forEach(el => {
                    el.classList.remove('error', 'success');
                });
                klantForm.querySelectorAll('.error-message').forEach(el => {
                    el.classList.remove('show');
                    el.textContent = '';
                });
                errorModal.style.display = 'none';
            }

            // --- Formulier Submit ---
            klantForm.addEventListener('submit', (e) => {
                e.preventDefault();
                clearAllErrors();
                const errors = validateForm();

                if (errors.length > 0) {
                    showValidationErrors(errors);
                    return;
                }

                // Zet laadstatus op knop
                modalSaveBtn.classList.add('loading');
                modalSaveBtn.disabled = true;

                const id = parseInt(document.getElementById('klant-id').value);
                const data = {
                    klantNaam: document.getElementById('klant-naam').value,
                    boekjaar: document.getElementById('klant-boekjaar').value,
                    budget: document.getElementById('klant-budget').value,
                    partnerManager: document.getElementById('klant-partner').value,
                    verantwoordelijkTeam: document.getElementById('klant-verantwoordelijk').value,
                    planbaarDoorTeams: document.getElementById('klant-planbaar').value,
                    startdatum: document.getElementById('klant-startdatum').value,
                    einddatum: document.getElementById('klant-einddatum').value
                };

                // Simuleer opslaan
                setTimeout(() => {
                    if (id) {
                        // Bewerken
                        const index = klantenData.findIndex(k => k.id === id);
                        if (index > -1) {
                            klantenData[index] = { ...klantenData[index], ...data };
                        }
                        showSuccessNotification('Klant succesvol bijgewerkt!');
                    } else {
                        // Nieuw
                        data.id = Date.now(); // Simpel ID
                        klantenData.push(data);
                        showSuccessNotification('Klant succesvol toegevoegd!');
                    }
                    
                    saveKlanten();
                    populateFilters();
                    applyFilters();
                    closeModal();
                    
                    modalSaveBtn.classList.remove('loading');
                    modalSaveBtn.disabled = false;
                }, 500); // Korte vertraging
            });

            // --- Bevestiging & Notificatie Logica ---
            function showConfirmDelete(ids, naam) {
                const confirmTitle = document.getElementById('confirmTitle');
                const confirmMessage = document.getElementById('confirmMessage');
                const confirmDetails = document.getElementById('confirmDetails');
                const confirmBtn = document.getElementById('confirmBtn');

                confirmTitle.textContent = 'Klant(en) Verwijderen';
                confirmMessage.textContent = `Weet je zeker dat je ${naam} wilt verwijderen?`;
                confirmDetails.style.display = 'none';
                confirmBtn.textContent = 'Verwijderen';
                confirmBtn.className = 'btn btn-danger'; // Zorg dat het 'gevaar' stijl heeft
                
                confirmModal.style.display = 'flex'; // GEWIJZIGD

                confirmBtn.onclick = () => {
                    handleDelete(ids);
                    confirmModal.style.display = 'none';
                };
            }

            function handleDelete(ids) {
                klantenData = klantenData.filter(k => !ids.includes(k.id));
                geselecteerdeIds.clear();
                saveKlanten();
                populateFilters();
                applyFilters();
                showSuccessNotification(`${ids.length} klant(en) succesvol verwijderd.`);
            }

            function showSuccessNotification(message) {
                successNotification.style.display = 'flex';
                document.getElementById('successMessage').textContent = message;
                setTimeout(() => {
                    successNotification.style.display = 'none';
                }, 3000);
            }
            
            // --- Event Listeners Toewijzen ---
            
            // Modals sluiten
            [closeModalBtn, cancelBtn, closeErrorModal, closeErrorBtn].forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.currentTarget.closest('.modal').style.display = 'none';
                });
            });
            document.getElementById('closeConfirmModal').addEventListener('click', () => confirmModal.style.display = 'none');
            document.getElementById('cancelConfirmBtn').addEventListener('click', () => confirmModal.style.display = 'none');
            document.getElementById('closeSuccessNotification').addEventListener('click', () => successNotification.style.display = 'none');

            // Nieuwe klant knop
            addKlantBtn.addEventListener('click', () => openKlantModal('new'));

            // Filters
            searchInput.addEventListener('input', () => {
                clearSearchBtn.style.display = searchInput.value ? 'block' : 'none';
                applyFilters();
            });
            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                clearSearchBtn.style.display = 'none';
                applyFilters();
            });
            [partnerFilter, teamFilter].forEach(el => el.addEventListener('change', applyFilters));
            clearFiltersBtn.addEventListener('click', () => {
                searchInput.value = '';
                clearSearchBtn.style.display = 'none';
                partnerFilter.value = '';
                teamFilter.value = '';
                applyFilters();
            });
            clearAllFiltersBtn.addEventListener('click', () => clearFiltersBtn.click());

            // Bulk selectie
            setupBulkSelection();

            // --- Initialisatie ---
            laadKlanten();
        });
    </script>
</body>
</html>