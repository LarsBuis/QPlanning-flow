<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Gebruikersbeheer - QPlanning</title>
    <base href="/" />
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../medewerkerbeheer.css">
    <style>
        /* Layout header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .page-header-actions { display: flex; gap: .5rem; flex-wrap: wrap; }

        /* Foutmeldingen bij inputs */
        .error-message { color: #d32f2f; font-size: .8rem; line-height: 1.2; margin-top: .25rem; display: none; }
        .error-message.show { display: block; }
        input.error, select.error { border-color: #d32f2f; background-color: #fff5f5; }

        /* Buttons */
        .btn { display: inline-flex; align-items: center; gap: .4rem; border: 0; border-radius: .4rem; font-size: .9rem; line-height: 1.2; font-weight: 500; cursor: pointer; padding: .6rem .8rem; }
        .btn-primary { background-color: #2563eb; color: #fff; }
        .btn-secondary { background-color: #e5e7eb; color: #111827; }
        .btn-danger { background-color: #dc2626; color: #fff; }

        .btn-action { display: inline-flex; align-items: center; gap: .4rem; background: #f3f4f6; color: #111827; border: 1px solid #d1d5db; border-radius: .4rem; font-size: .8rem; line-height: 1.2; padding: .4rem .6rem; cursor: pointer; }
        .btn-action svg { min-width: 16px; }

        /* Tabel + bulkbar */
        .table-container { overflow-x: auto; }
        .bulk-actions-bar { background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: .5rem; padding: .75rem 1rem; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: .75rem; }
        .no-results { text-align: center; padding: 2rem 1rem; color: #6b7280; }
        .no-results-icon { font-size: 2rem; margin-bottom: .5rem; }
        .loading { opacity: .6; pointer-events: none; }

        /* Form layout */
        .form-row { display: flex; flex-wrap: wrap; gap: 1rem; }
        .form-group { flex: 1; min-width: 0; display: flex; flex-direction: column; margin-bottom: 1rem; }
        label { font-size: .9rem; font-weight: 500; color: #374151; margin-bottom: .4rem; }
        input[type="text"], input[type="email"], input[type="number"], input[type="password"], select {
            border: 1px solid #d1d5db; border-radius: .4rem; padding: .6rem .7rem; font-size: .9rem; background-color: #fff;
        }

        .form-info { display: flex; justify-content: flex-end; padding: .25rem 1.25rem 0 1.25rem; }
        .form-info small em { font-style: normal; color: #6b7280; }

        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); align-items: center; justify-content: center; z-index: 9999; }
        .modal-content { background: #fff; border-radius: .5rem; box-shadow: 0 2rem 4rem rgba(0,0,0,.15); width: 100%; max-width: 640px; max-height: 90dvh; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header, .modal-footer { padding: 1rem 1.25rem; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; gap: .5rem; }
        .modal-footer { border-top: 1px solid #e5e7eb; border-bottom: none; }
        .modal-body { padding: 1rem 1.25rem; overflow-y: auto; }
        .modal-close { background: none; border: 0; font-size: 1.25rem; line-height: 1; cursor: pointer; color: #6b7280; }

        /* === Multiselect (checkbox dropdown) voor Rollen === */
        .multiselect { position: relative; }
        .multiselect-toggle{
          width: 100%;
          display: flex; align-items: center; justify-content: space-between;
          gap: .5rem;
          padding: .6rem .7rem;
          background: #fff;
          border: 1px solid #d1d5db; border-radius: .4rem;
          font-size: .9rem; color: #111827; cursor: pointer;
        }
        .multiselect-toggle:focus { outline: none; box-shadow: 0 0 0 3px rgba(37,99,235,.25); }
        .multiselect.error .multiselect-toggle{ border-color: #d32f2f; background: #fff5f5; }

        .multiselect-panel{
          position: absolute; z-index: 10000;
          top: calc(100% + 6px); left: 0; right: 0;
          background: #fff; border: 1px solid #e5e7eb; border-radius: .5rem;
          box-shadow: 0 12px 24px rgba(0,0,0,.12);
          padding: .5rem; display: none; max-height: 280px; overflow: auto;
        }
        .multiselect.open .multiselect-panel{ display: block; }

        .multiselect-panel .option{
          display: flex; align-items: center; gap: .6rem;
          padding: .4rem .5rem; border-radius: .35rem; cursor: pointer;
          user-select: none;
        }
        .multiselect-panel .option:hover{ background: #f3f4f6; }
        .multiselect-panel input[type="checkbox"]{ width: 16px; height: 16px; }

        #rollenSummary{ overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    </style>
</head>
<body>
<header class="header">
    <div class="header-container">
        <div class="header-left">
            <div class="logo"><h1>QPlanning</h1></div>
            <nav class="main-nav">
                <ul class="nav-list">
                    <li><a href="/index.html" class="nav-link">Overzicht</a></li>
                    <li class="dropdown">
                        <a href="#" class="nav-link dropdown-toggle">Plannen</a>
                        <ul class="dropdown-menu">
                            <li><a href="/Boekingen/BoekingOverzicht.html" class="dropdown-link">Boekingen</a></li>
                            <li><a href="#" class="dropdown-link">Klantenplanning</a></li>
                            <li><a href="#" class="dropdown-link">Medewerkerplanning</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="nav-link dropdown-toggle">Beheer</a>
                        <ul class="dropdown-menu">
                            <li><a href="/klanten/klant.html" class="dropdown-link">Klanten beheren</a></li>
                            <li><a href="/Medewerker/medewerkerbeheer.html" class="dropdown-link">Medewerkers beheren</a></li>
                            <li><a href="/Gebruikers/Gebruikers.html" class="dropdown-link active">Gebruikers beheren</a></li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </div>
        <div class="header-right">
            <div class="account-dropdown">
                <button class="account-btn" id="accountBtn" aria-label="Account menu">
                    <svg class="account-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </button>
                <ul class="account-menu" id="accountMenu">
                    <li><a href="#" class="account-link">Wijzig wachtwoord</a></li>
                    <li><a href="#" class="account-link">Log uit</a></li>
                </ul>
            </div>
        </div>
    </div>
</header>

<main class="main-content">
    <div class="content-container">
        <div class="page-header">
            <h2>Gebruikersbeheer</h2>
            <div class="page-header-actions">
                <button class="btn btn-primary" id="add-gebruiker-btn">Nieuwe gebruiker toevoegen</button>
            </div>
        </div>

        <div class="filters-section">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Zoek op naam, e-mail, gebruikersnaam..." class="search-input">
                <button class="search-clear" id="clearSearch" title="Zoekopdracht wissen" style="display:none;">√ó</button>
            </div>
            <div class="filter-options">
                <select id="rolFilter" class="filter-select">
                    <option value="">Alle Rollen</option>
                </select>
                <button class="btn btn-secondary" id="clearFilters">Filters wissen</button>
            </div>
        </div>

        <div class="bulk-actions-bar" id="bulkActionsBar" style="display:none;">
            <div class="bulk-info"><span id="selectedCount">0</span> gebruikers geselecteerd</div>
            <div class="bulk-buttons">
                <button class="btn btn-secondary" id="bulkDelete">Verwijderen</button>
            </div>
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="select-column"><input type="checkbox" id="selectAllCheckbox" class="select-checkbox"></th>
                        <th>Naam</th>
                        <th>E-mail</th>
                        <th>Gebruikersnaam</th>
                        <th>Rollen</th>
                        <th>Acties</th>
                    </tr>
                </thead>
                <tbody id="gebruikers-tabel-body"></tbody>
            </table>
        </div>

        <div class="no-results" id="noResults" style="display:none;">
            <div class="no-results-icon">üîç</div>
            <h3>Geen gebruikers gevonden</h3>
            <p>Probeer andere zoektermen of filters.</p>
            <button class="btn btn-primary" id="clearAllFilters">Alle filters wissen</button>
        </div>
    </div>
</main>

<!-- GEBRUIKER MODAL -->
<div class="modal" id="gebruiker-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Nieuwe gebruiker</h3>
            <button class="modal-close" id="closeModal" aria-label="Sluit modal">&times;</button>
        </div>

        <!-- rechtsboven verplichtheid -->
        <div class="form-info">
            <small><em>* Verplichte velden</em></small>
        </div>

        <form id="gebruiker-form" class="modal-body" novalidate>
            <input type="hidden" id="gebruiker-id">

            <div class="form-row">
                <div class="form-group">
                    <label for="voornaam">Voornaam *</label>
                    <input type="text" id="voornaam" name="voornaam" placeholder="Bijv. Jan" required>
                    <div class="error-message" id="voornaamError"></div>
                </div>
                <div class="form-group">
                    <label for="achternaam">Achternaam *</label>
                    <input type="text" id="achternaam" name="achternaam" placeholder="Bijv. Jansen" required>
                    <div class="error-message" id="achternaamError"></div>
                </div>
                <div class="form-group">
                    <label for="tussenvoegsel">Tussenvoegsel</label>
                    <input type="text" id="tussenvoegsel" name="tussenvoegsel" placeholder="(optioneel)">
                    <div class="error-message" id="tussenvoegselError"></div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="email">E-mail *</label>
                    <input type="email" id="email" name="email" placeholder="bijv. jan.jansen@qplanning.nl" required>
                    <div class="error-message" id="emailError"></div>
                </div>
                <div class="form-group">
                    <label for="gebruikersnaam">Gebruikersnaam *</label>
                    <input type="text" id="gebruikersnaam" name="gebruikersnaam" placeholder="bijv. jjansen" required>
                    <div class="error-message" id="gebruikersnaamError"></div>
                </div>
                <div class="form-group">
                    <label for="wachtwoord">Wachtwoord *</label>
                    <input type="password" id="wachtwoord" name="wachtwoord" placeholder="Min. 8 tekens" required>
                    <div class="error-message" id="wachtwoordError"></div>
                </div>
            </div>

            <!-- Multiselect dropdown voor Rollen -->
            <div class="form-group">
                <label>Rollen *</label>

                <div class="multiselect" id="rollenSelect">
                    <button type="button" class="multiselect-toggle" id="rollenToggle"
                        aria-expanded="false" aria-haspopup="listbox">
                        <span id="rollenSummary">Selecteer rollen‚Ä¶</span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>

                    <div class="multiselect-panel" id="rollenPanel" role="listbox" aria-multiselectable="true">
                        <label class="option"><input type="checkbox" value="Admin"><span>Admin</span></label>
                        <label class="option"><input type="checkbox" value="Manager"><span>Manager</span></label>
                        <label class="option"><input type="checkbox" value="Planner"><span>Planner</span></label>
                        <label class="option"><input type="checkbox" value="Medewerker"><span>Medewerker</span></label>
                        <label class="option"><input type="checkbox" value="Gast"><span>Gast</span></label>
                    </div>
                </div>

                <div class="error-message" id="rollenSelectError"></div>
            </div>
        </form>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelBtn">Annuleren</button>
            <button type="submit" class="btn btn-primary" form="gebruiker-form" id="modal-save-btn">Toevoegen</button>
        </div>
    </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal" id="confirmModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="confirmTitle">Bevestiging vereist</h3>
            <button class="modal-close" id="closeConfirmModal">&times;</button>
        </div>
        <div class="modal-body">
            <p id="confirmMessage">Weet je zeker dat je deze actie wilt uitvoeren?</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelConfirmBtn">Annuleren</button>
            <button type="button" class="btn btn-danger" id="confirmBtn">Bevestigen</button>
        </div>
    </div>
</div>

<!-- SUCCESS TOAST -->
<div class="success-notification" id="successNotification" style="display:none;">
    <div class="success-icon">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <path d="M9 12l2 2 4-4"></path><circle cx="12" cy="12" r="10"></circle>
        </svg>
    </div>
    <div class="success-message" id="successMessage">Actie succesvol uitgevoerd</div>
    <button class="success-close" id="closeSuccessNotification">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"></path>
        </svg>
    </button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Normalisatie helpers (naam/tussenvoegsel/email) ---
    function normalizeWhitespace(str) {
      return (str || '').replace(/\s+/g, ' ').trim();
    }
    const DUTCH_PARTICLES = new Set([
      'de','den','der','van','het','te','ten','ter','op','aan','bij','uit','in','von','vom','am','auf'
    ]);
    function capitalizeToken(token) {
      return token.split(/([-‚Äô'‚Äì‚Äî])/).map((part) => {
        if (/^[-‚Äô'‚Äì‚Äî]$/.test(part)) return part;
        if (!part) return part;
        return part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();
      }).join('');
    }
    function toNameCase(full, {treatParticlesLower = true} = {}) {
      full = normalizeWhitespace(full);
      if (!full) return '';
      const words = full.split(' ');
      return words.map((w, i) => {
        const lower = w.toLowerCase();
        if (i === 0) return capitalizeToken(lower);
        if (treatParticlesLower && DUTCH_PARTICLES.has(lower)) return lower;
        return capitalizeToken(lower);
      }).join(' ');
    }
    function toTussenvoegselCase(v) {
      v = normalizeWhitespace(v);
      if (!v) return '';
      return v.split(' ').map(w => w.toLowerCase()).join(' ');
    }

    // --- State
    let gebruikersData = [];
    let gefilterdeGebruikers = [];
    let geselecteerdeIds = new Set();
    const storageKey = 'qplanning_gebruikers_v2';

    // DOM
    const tabelBody = document.getElementById('gebruikers-tabel-body');
    const addBtn = document.getElementById('add-gebruiker-btn');

    const modal = document.getElementById('gebruiker-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalSaveBtn = document.getElementById('modal-save-btn');
    const closeModalBtn = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const gebruikerForm = document.getElementById('gebruiker-form');

    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearch');
    const rolFilter = document.getElementById('rolFilter');

    const bulkActionsBar = document.getElementById('bulkActionsBar');
    const selectedCountEl = document.getElementById('selectedCount');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const bulkDeleteBtn = document.getElementById('bulkDelete');

    const confirmModal = document.getElementById('confirmModal');
    const confirmBtn = document.getElementById('confirmBtn');

    const successNotification = document.getElementById('successNotification');
    const successMessage = document.getElementById('successMessage');
    const closeSuccessNotificationBtn = document.getElementById('closeSuccessNotification');

    // Header dropdowns (nav)
    const dropdowns = document.querySelectorAll('.dropdown');
    const accountBtn = document.getElementById('accountBtn');
    const accountDropdown = document.querySelector('.account-dropdown');
    dropdowns.forEach(d => {
        const t = d.querySelector('.dropdown-toggle');
        t.addEventListener('click', (e)=>{e.preventDefault();e.stopPropagation();
            dropdowns.forEach(x=>{if(x!==d) x.classList.remove('active');});
            d.classList.toggle('active');
        });
    });
    accountBtn.addEventListener('click', (e)=>{e.preventDefault();e.stopPropagation();accountDropdown.classList.toggle('active');});
    document.addEventListener('click', ()=>{ dropdowns.forEach(d=>d.classList.remove('active')); accountDropdown.classList.remove('active');});
    document.querySelectorAll('.dropdown-menu, .account-menu').forEach(m=>m.addEventListener('click', e=>e.stopPropagation()));

    // Helpers
    function fullName(g) { return [g.voornaam, g.tussenvoegsel, g.achternaam].filter(Boolean).join(' '); }
    function saveGebruikers() { localStorage.setItem(storageKey, JSON.stringify(gebruikersData)); }

    async function laadGebruikers() {
        const ls = localStorage.getItem(storageKey);
        let ok = false;
        if (ls) {
            try { const data = JSON.parse(ls); if (Array.isArray(data)) { gebruikersData = data; ok = true; } } catch(e){}
        }
        if (!ok) {
            try {
                const resp = await fetch('/Gebruikers/Gebruikers.json');
                if (!resp.ok) throw new Error('Kon Gebruikers.json niet laden');
                gebruikersData = await resp.json();
                saveGebruikers();
            } catch (e) { console.error(e); gebruikersData = []; }
        }
        populateFilters();
        applyFilters();
    }

    // === Multiselect (Rollen) ===
    const rollenWrapper = document.getElementById('rollenSelect');
    const rollenToggle = document.getElementById('rollenToggle');
    const rollenPanel  = document.getElementById('rollenPanel');
    const rollenSummary= document.getElementById('rollenSummary');

    function openRollen(){ rollenWrapper.classList.add('open'); rollenToggle.setAttribute('aria-expanded','true'); }
    function closeRollen(){ rollenWrapper.classList.remove('open'); rollenToggle.setAttribute('aria-expanded','false'); }
    function toggleRollen(){ rollenWrapper.classList.contains('open') ? closeRollen() : openRollen(); }

    function getCheckedRollen() {
      const boxen = document.querySelectorAll('#rollenPanel input[type="checkbox"]');
      return Array.from(boxen).filter(b => b.checked).map(b => b.value);
    }
    function setCheckedRollen(values = []) {
      const set = new Set(values);
      const boxen = document.querySelectorAll('#rollenPanel input[type="checkbox"]');
      boxen.forEach(b => { b.checked = set.has(b.value); });
      updateRollenSummary();
    }
    function updateRollenSummary(){
      const sel = getCheckedRollen();
      if (sel.length === 0) rollenSummary.textContent = 'Selecteer rollen‚Ä¶';
      else if (sel.length <= 3) rollenSummary.textContent = sel.join(', ');
      else rollenSummary.textContent = `${sel.length} rollen geselecteerd`;
    }
    rollenToggle.addEventListener('click', (e)=>{ e.stopPropagation(); toggleRollen(); });
    rollenPanel.addEventListener('click', (e)=>{
      if (e.target && e.target.type === 'checkbox') updateRollenSummary();
    });
    document.addEventListener('click', (e)=>{ if (!rollenWrapper.contains(e.target)) closeRollen(); });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeRollen(); });

    // Filters
    function populateFilters() {
        const rollen = new Set( gebruikersData.flatMap(g => Array.isArray(g.rollen) ? g.rollen : (g.rollen ? [g.rollen] : []) ) );
        rolFilter.innerHTML = '<option value="">Alle Rollen</option>';
        Array.from(rollen).sort().forEach(r => rolFilter.add(new Option(r, r)));
    }

    function applyFilters() {
        const term = (searchInput.value || '').toLowerCase();
        const rol = rolFilter.value;

        gefilterdeGebruikers = gebruikersData.filter(g => {
            const tMatch = !term ||
                fullName(g).toLowerCase().includes(term) ||
                (g.email || '').toLowerCase().includes(term) ||
                (g.gebruikersnaam || '').toLowerCase().includes(term);

            const rMatch = !rol || (Array.isArray(g.rollen) ? g.rollen.includes(rol) : g.rollen === rol);

            return tMatch && rMatch;
        });

        renderTabel();
        updateBulkActionsBar();
    }

    // Render
    function renderTabel() {
        const body = tabelBody; body.innerHTML = '';
        const tableContainer = document.querySelector('.table-container');
        const noResults = document.getElementById('noResults');

        if (gefilterdeGebruikers.length === 0) {
            tableContainer.style.display = 'none';
            noResults.style.display = 'block';
            return;
        }
        tableContainer.style.display = 'block';
        noResults.style.display = 'none';

        gefilterdeGebruikers.forEach(g => {
            const tr = document.createElement('tr');
            const checked = geselecteerdeIds.has(g.id);
            const rollenText = Array.isArray(g.rollen) ? g.rollen.join(', ') : (g.rollen || '-');

            tr.innerHTML = `
                <td class="select-column">
                    <input type="checkbox" class="row-checkbox select-checkbox" data-id="${g.id}" ${checked ? 'checked' : ''}>
                </td>
                <td data-label="Naam">${fullName(g) || '-'}</td>
                <td data-label="E-mail">${g.email || '-'}</td>
                <td data-label="Gebruikersnaam">${g.gebruikersnaam || '-'}</td>
                <td data-label="Rollen">${rollenText}</td>
                <td class="actions">
                    <div class="action-buttons">
                        <button class="btn-action btn-edit" data-id="${g.id}" title="Bewerken">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                            <span>Bewerken</span>
                        </button>
                        <button class="btn-action btn-delete" data-id="${g.id}" title="Verwijderen">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            <span>Verwijderen</span>
                        </button>
                    </div>
                </td>
            `;
            body.appendChild(tr);
        });

        koppelTabelActies();
    }

    // Actions
    function koppelTabelActies() {
        tabelBody.querySelectorAll('.row-checkbox').forEach(cb => {
            cb.addEventListener('change', (e) => {
                const id = parseInt(e.target.dataset.id);
                if (e.target.checked) geselecteerdeIds.add(id);
                else geselecteerdeIds.delete(id);
                updateBulkActionsBar();
            });
        });
        tabelBody.querySelectorAll('.btn-edit').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = parseInt(e.currentTarget.dataset.id);
                openGebruikerModal('edit', id);
            });
        });
        tabelBody.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = parseInt(e.currentTarget.dataset.id);
                const g = gebruikersData.find(x => x.id === id);
                showConfirmDelete([id], g ? `gebruiker "${fullName(g)}"` : 'deze gebruiker');
            });
        });
    }

    // Bulk selection
    function setupBulkSelection() {
        selectAllCheckbox.addEventListener('change', () => {
            if (selectAllCheckbox.checked) { gefilterdeGebruikers.forEach(g => geselecteerdeIds.add(g.id)); }
            else { gefilterdeGebruikers.forEach(g => geselecteerdeIds.delete(g.id)); }
            renderTabel();
            updateBulkActionsBar();
        });

        bulkDeleteBtn.addEventListener('click', () => {
            showConfirmDelete([...geselecteerdeIds], `${geselecteerdeIds.size} gebruikers`);
        });
    }
    function updateBulkActionsBar() {
        const count = gefilterdeGebruikers.filter(g => geselecteerdeIds.has(g.id)).length;
        if (count === 0) {
            bulkActionsBar.style.display = 'none';
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else {
            bulkActionsBar.style.display = 'flex';
            selectedCountEl.textContent = count;
            selectAllCheckbox.checked = count === gefilterdeGebruikers.length;
            selectAllCheckbox.indeterminate = count < gefilterdeGebruikers.length;
        }
    }

    // Errors
    function clearErrors() {
        ['voornaam','achternaam','tussenvoegsel','email','gebruikersnaam','wachtwoord','rollenSelect']
            .forEach(id => {
                const el = document.getElementById(id);
                const errEl = document.getElementById(id + 'Error') || document.getElementById('rollenSelectError');
                if (el) el.classList.remove('error');
                if (errEl) { errEl.textContent=''; errEl.classList.remove('show'); }
                if (id === 'rollenSelect') document.getElementById('rollenSelect').classList.remove('error');
            });
    }
    function showError(id, msg) {
        const el = document.getElementById(id);
        const err = document.getElementById(id + 'Error') || (id === 'rollenSelect' ? document.getElementById('rollenSelectError') : null);
        if (el) el.classList.add('error');
        if (err) { err.textContent = msg; err.classList.add('show'); }
        if (id === 'rollenSelect') document.getElementById('rollenSelect').classList.add('error');
    }

    // Validatie
    function validateForm() {
        const errors = [];
        const voornaam = document.getElementById('voornaam').value.trim();
        const achternaam = document.getElementById('achternaam').value.trim();
        const email = document.getElementById('email').value.trim();
        const gebruikersnaam = document.getElementById('gebruikersnaam').value.trim();
        const wachtwoord = document.getElementById('wachtwoord').value;

        if (!voornaam) errors.push({id:'voornaam', msg:'Voornaam is verplicht.'});
        if (voornaam && voornaam.length < 2) errors.push({id:'voornaam', msg:'Voornaam moet minimaal 2 karakters zijn.'});
        if (!achternaam) errors.push({id:'achternaam', msg:'Achternaam is verplicht.'});
        if (achternaam && achternaam.length < 2) errors.push({id:'achternaam', msg:'Achternaam moet minimaal 2 karakters zijn.'});

        if (!email) errors.push({id:'email', msg:'E-mail is verplicht.'});
        else {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!re.test(email)) errors.push({id:'email', msg:'Voer een geldig e-mailadres in.'});
        }

        if (!gebruikersnaam) errors.push({id:'gebruikersnaam', msg:'Gebruikersnaam is verplicht.'});
        if (!wachtwoord) errors.push({id:'wachtwoord', msg:'Wachtwoord is verplicht.'});
        else if (wachtwoord.length < 8) errors.push({id:'wachtwoord', msg:'Wachtwoord moet minimaal 8 tekens zijn.'});

        const rollen = getCheckedRollen();
        if (rollen.length === 0) errors.push({id:'rollenSelect', msg:'Selecteer minimaal √©√©n rol.'});

        return errors;
    }

    // Modal open/close
    function openGebruikerModal(mode, id=null) {
        clearErrors();
        gebruikerForm.reset();
        document.getElementById('gebruiker-id').value = '';
        setCheckedRollen([]); // reset
        updateRollenSummary();
        closeRollen();

        if (mode === 'edit') {
            const g = gebruikersData.find(x => x.id === id);
            if (!g) return;
            document.getElementById('modal-title').textContent = 'Gebruiker bewerken';
            modalSaveBtn.textContent = 'Wijzigingen opslaan';

            document.getElementById('gebruiker-id').value = g.id;
            document.getElementById('voornaam').value = g.voornaam || '';
            document.getElementById('achternaam').value = g.achternaam || '';
            document.getElementById('tussenvoegsel').value = g.tussenvoegsel || '';
            document.getElementById('email').value = g.email || '';
            document.getElementById('gebruikersnaam').value = g.gebruikersnaam || '';
            document.getElementById('wachtwoord').value = g.wachtwoord || '';
            const rollen = Array.isArray(g.rollen) ? g.rollen : (g.rollen ? [g.rollen] : []);
            setCheckedRollen(rollen);
            updateRollenSummary();
        } else {
            document.getElementById('modal-title').textContent = 'Nieuwe gebruiker';
            modalSaveBtn.textContent = 'Toevoegen';
        }
        modal.style.display = 'flex';
    }
    function closeModal() {
        modal.style.display = 'none';
        clearErrors();
        gebruikerForm.reset();
        setCheckedRollen([]);
        updateRollenSummary();
        closeRollen();
    }

    // Confirm + toast
    function showConfirmDelete(ids, naam) {
        const title = ids.length > 1 ? 'Gebruikers verwijderen' : 'Gebruiker verwijderen';
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = `Weet je zeker dat je ${naam} wilt verwijderen?`;
        confirmModal.style.display = 'flex';
        confirmBtn.onclick = () => { handleDelete(ids); confirmModal.style.display = 'none'; };
    }
    function handleDelete(ids) {
        gebruikersData = gebruikersData.filter(g => !ids.includes(g.id));
        geselecteerdeIds.clear();
        saveGebruikers();
        populateFilters();
        applyFilters();
        showSuccess('Gebruiker(s) succesvol verwijderd.');
    }
    function showSuccess(msg) {
        successMessage.textContent = msg;
        successNotification.style.display = 'flex';
        setTimeout(()=>{ successNotification.style.display='none'; }, 3000);
    }

    // Events
    document.getElementById('clearFilters').addEventListener('click', ()=>{
        searchInput.value = '';
        clearSearchBtn.style.display = 'none';
        rolFilter.value='';
        applyFilters();
    });
    document.getElementById('clearAllFilters').addEventListener('click', ()=> document.getElementById('clearFilters').click());
    rolFilter.addEventListener('change', applyFilters);

    addBtn.addEventListener('click', ()=>openGebruikerModal('new'));
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('cancelBtn').addEventListener('click', closeModal);
    document.getElementById('closeConfirmModal').addEventListener('click', ()=>document.getElementById('confirmModal').style.display='none');
    document.getElementById('cancelConfirmBtn').addEventListener('click', ()=>document.getElementById('confirmModal').style.display='none');
    closeSuccessNotificationBtn.addEventListener('click', ()=>successNotification.style.display='none');

    searchInput.addEventListener('input', ()=>{
        clearSearchBtn.style.display = searchInput.value ? 'block' : 'none';
        applyFilters();
    });
    clearSearchBtn.addEventListener('click', ()=>{
        searchInput.value = '';
        clearSearchBtn.style.display = 'none';
        applyFilters();
    });

    // === Submit handler met normalisatie v√≥√≥r validatie ===
    gebruikerForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        clearErrors();

        // Normaliseer invoer v√≥√≥r validatie/opslaan
        const voornaamEl = document.getElementById('voornaam');
        const achternaamEl = document.getElementById('achternaam');
        const tussenvoegselEl = document.getElementById('tussenvoegsel');
        const emailEl = document.getElementById('email');
        const gebruikersnaamEl = document.getElementById('gebruikersnaam');

        const normVoornaam = toNameCase(voornaamEl.value, {treatParticlesLower: false});
        const normAchternaam = toNameCase(achternaamEl.value);
        const normTussenvoegsel = toTussenvoegselCase(tussenvoegselEl.value);

        voornaamEl.value = normVoornaam;
        achternaamEl.value = normAchternaam;
        tussenvoegselEl.value = normTussenvoegsel;
        emailEl.value = normalizeWhitespace(emailEl.value).toLowerCase();
        gebruikersnaamEl.value = normalizeWhitespace(gebruikersnaamEl.value);
        // Als je gebruikersnamen verplicht lowercase wilt:
        // gebruikersnaamEl.value = gebruikersnaamEl.value.toLowerCase();

        const errs = validateForm();
        if (errs.length) { errs.forEach(er => showError(er.id, er.msg)); return; }

        modalSaveBtn.classList.add('loading');
        modalSaveBtn.disabled = true;

        const id = parseInt(document.getElementById('gebruiker-id').value);
        const data = {
            voornaam: voornaamEl.value,
            achternaam: achternaamEl.value,
            tussenvoegsel: tussenvoegselEl.value,
            email: emailEl.value,
            gebruikersnaam: gebruikersnaamEl.value,
            wachtwoord: document.getElementById('wachtwoord').value,
            rollen: getCheckedRollen()
        };

        setTimeout(()=>{
            if (id) {
                const idx = gebruikersData.findIndex(g => g.id === id);
                if (idx > -1) gebruikersData[idx] = { ...gebruikersData[idx], ...data };
                showSuccess('Gebruiker succesvol bijgewerkt!');
            } else {
                data.id = Date.now();
                gebruikersData.push(data);
                showSuccess('Gebruiker succesvol toegevoegd!');
            }
            saveGebruikers();
            populateFilters();
            applyFilters();
            closeModal();
            modalSaveBtn.classList.remove('loading');
            modalSaveBtn.disabled = false;
        }, 250);
    });

    // Opstart
    setupBulkSelection();
    updateRollenSummary();
    laadGebruikers();
});
</script>
</body>
</html>
